# Проблемы и риски при переходе к Event-Driven архитектуре

## Текущие проблемы

1. **Синхронная агрегация данных в `ins-product-aggregator`**  
   Сервис выполняет блокирующие вызовы к API всех страховых компаний в рамках одного HTTP-запроса. При увеличении числа партнёров:
    - Резко возрастает latency,
    - Повышается вероятность таймаутов или частичных сбоев,
    - Снижается общая доступность сервиса.

2. **Зависимость от доступности внешних партнёров**  
   При недоступности хотя бы одной страховой компании:
    - Может нарушаться целостность каталога (если реализована строгая агрегация),
    - Возникает риск предоставления устаревших или неполных данных.

3. **Синхронная зависимость между `core-app` и `ins-comp-settlement`**  
   Ежедневный REST-вызов для получения списка оформленных полисов:
    - Создаёт тесную связь (tight coupling),
    - В случае недоступности `core-app` в момент выгрузки — данные теряются или требуют повторной обработки.

4. **Рассинхрон данных между сервисами**
    - `core-app` обновляет каталог раз в 15 минут,
    - `ins-comp-settlement` — раз в сутки.  
      → Это приводит к **неконсистентности** при формировании реестров и отчётности.

## Критические риски при масштабировании (5 → 10 страховых компаний)

1. **Удвоение нагрузки на `ins-product-aggregator`**  
   Увеличение количества исходящих вызовов в 2 раза ведёт к:
    - Росту потребления CPU, памяти и сетевых ресурсов,
    - Повышенному риску исчерпания пула соединений (например, сокетов в состоянии `TIME_WAIT`).

2. **Пиковая, а не равномерная нагрузка**  
   Запросы к партнёрам и формирование реестров происходят в фиксированное время:
    - Создаются нагрузочные пики,
    - Может снижаться качество обслуживания (SLA) в моменты пикового трафика.

3. **Отсутствие отказоустойчивости при частичных сбоях**  
   В архитектуре не реализованы:
    - Кэширование результатов по отдельным партнёрам,
    - Повторные попытки (retry) с экспоненциальной задержкой,
    - Circuit Breaker для изоляции проблемных API.

4. **Одноточечный отказ инфраструктуры**
    - База данных размещена в одной зоне доступности,
    - Нет репликации или кросс-регион резервирования → риск полной недоступности при сбое ZD.

5. **Отсутствие защиты от внешней нагрузки**  
   Нет механизма:
    - Rate limiting по партнёрам,
    - Квотирования или тарификации вызовов,  
      → Злоумышленный или ошибочный клиент может вызвать cascading failure.

6. **Несоответствие принципам Event-Driven Architecture (EDA)**  
   Бизнес-события (`PolicyCreated`, `ProductUpdated`) реализуются через polling и REST-вызовы:
    - Это ведёт к избыточному трафику и задержкам,
    - Усложняет логику обработки и поддержку системы.

## Рекомендуемое направление решения

Переход на **асинхронную Event-Driven архитектуру** с использованием шины сообщений (например, Apache Kafka):
- `ins-product-aggregator` публикует событие `ProductUpdated` при любом изменении каталога,
- `core-app` и `ins-comp-settlement` подписываются на события — без REST-вызовов,
- `core-app` публикует `PolicyCreated` через **Transactional Outbox**,
- Все взаимодействия — **асинхронные, идемпотентные, с поддержкой retries и dead-letter queues**.

Такой подход устранит tight coupling, обеспечит **масштабируемость**, **согласованность** и **отказоустойчивость** при росте числа партнёров.